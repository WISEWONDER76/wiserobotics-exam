<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WISEROBOTICS STEM Challenge — Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        :root{--accent: #4f46e5;}
        body{font-family: 'Inter', sans-serif; background: linear-gradient(180deg,#eef2ff 0%, #f8fafc 100%);}
        .card{border:1px solid rgba(15,23,42,0.04); box-shadow: 0 8px 30px rgba(2,6,23,0.06);} 
        .btn{transition:all .18s ease}
        .option-focus{outline: 3px solid rgba(79,70,229,0.12); transform: translateY(-2px);} 
        .progress-track{background:#e6e9f8;border-radius:999px; height:12px}
        .progress-fill{height:12px;border-radius:999px;background:linear-gradient(90deg,var(--accent),#06b6d4);transition:width .35s ease}
        /* small printable adjustments for certificate */
        @media print{
            body{background:white}
            .no-print{display:none}
            #certificate{page-break-inside:avoid}
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-4xl bg-white rounded-2xl p-6 md:p-10 card">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6 no-print">
                <div>
                    <h1 class="text-2xl md:text-3xl font-extrabold text-indigo-700">WISEROBOTICS & STEM — Online Challenge</h1>
                    <p class="text-sm text-gray-500 mt-1">30 Questions • 3 options each • 5 chances • Results saved to cloud (optional)</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-600">Admin:</div>
                    <div class="mt-1 flex gap-2">
                        <input id="adminKey" placeholder="admin pass" type="password" class="px-3 py-2 border rounded-lg text-sm" />
                        <button id="adminLogin" class="px-3 py-2 bg-indigo-600 text-white rounded-lg btn">Unlock</button>
                    </div>
                </div>
            </div>

            <div id="mainApp">
                <!-- Welcome area -->
                <div id="welcomeArea" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input id="inputName" placeholder="Full name" class="col-span-1 md:col-span-3 p-3 border rounded-lg" />
                        <input id="inputClass" placeholder="Class / Form (e.g., Year 9)" class="p-3 border rounded-lg" />
                        <input id="inputSchool" placeholder="School name" class="p-3 border rounded-lg" />
                        <input id="inputRegNo" placeholder="Reg. No (optional)" class="p-3 border rounded-lg" />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div class="col-span-2">
                            <label class="text-sm text-gray-600">Select Mode</label>
                            <select id="modeSelect" class="w-full p-3 border rounded-lg">
                                <option value="practice">Practice (no save)</option>
                                <option value="submit">Submit & Save (schools)</option>
                            </select>
                        </div>
                        <div class="text-right">
                            <button id="startButton" class="px-6 py-3 bg-teal-600 text-white rounded-xl font-bold btn">Begin the Challenge</button>
                        </div>
                    </div>
                    <p id="welcomeFeedback" class="text-sm text-red-500 h-5"></p>

                    <!-- Quick tips -->
                    <div class="mt-2 p-3 bg-indigo-50 rounded-lg text-sm text-gray-700">
                        Tip: When using "Submit & Save" make sure you have set up <strong>Firebase config</strong> (see instructions below). You can host this single file on GitHub Pages or Firebase Hosting.
                    </div>
                </div>

                <!-- Quiz area -->
                <div id="quizArea" style="display:none">
                    <div class="mb-4">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600">Student: <span id="summaryName" class="font-semibold"></span></div>
                            <div class="text-sm text-gray-600">Score: <span id="scoreDisplay">0</span></div>
                        </div>
                        <div class="mt-2">
                            <div class="progress-track w-full"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
                            <div class="text-xs text-gray-500 mt-1">Question <span id="questionNumber">1</span> / <span id="totalQuestions">30</span></div>
                        </div>
                    </div>

                    <div id="questionCard" class="p-6 bg-gray-50 rounded-xl mb-4">
                        <div id="questionText" class="text-xl md:text-2xl font-semibold text-gray-800">Loading...</div>
                    </div>

                    <div id="optionsContainer" class="grid grid-cols-1 gap-3 mb-4"></div>

                    <div id="quizControls" class="flex gap-3 no-print">
                        <button id="submitButton" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl btn" disabled>Submit Answer</button>
                        <button id="nextButton" class="flex-1 py-3 bg-gray-300 text-gray-800 rounded-xl btn" style="display:none">Next Question</button>
                        <button id="quitButton" class="flex-1 py-3 bg-red-600 text-white rounded-xl btn">Quit</button>
                    </div>

                    <div id="feedback" class="mt-4 min-h-[48px]"></div>
                </div>

                <!-- Results area -->
                <div id="resultArea" style="display:none">
                    <div class="text-center">
                        <h2 class="text-3xl font-extrabold text-teal-600">Challenge Ended</h2>
                        <p class="mt-2 text-gray-700" id="finalScoreText"></p>
                        <div id="userDetailsSummary" class="mt-4 p-4 bg-indigo-50 rounded-lg text-left inline-block text-sm text-gray-800"></div>

                        <div id="certificateArea" class="mt-6"></div>

                        <div class="mt-4 flex gap-3 justify-center no-print">
                            <button id="restartButton" class="px-5 py-3 bg-indigo-600 text-white rounded-lg btn">Start New</button>
                            <button id="downloadCSV" class="px-5 py-3 border rounded-lg btn" style="display:none">Download All Results</button>
                            <button id="printCert" class="px-5 py-3 bg-teal-600 text-white rounded-lg btn" style="display:none">Print Certificate</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Firebase + App Logic -->
    <script type="module">
        // ---------- FIREBASE SETUP (paste your config here) ----------
        /*
         * IMPORTANT: Replace the firebaseConfig object below with your project's config from the
         * Firebase Console (Project Settings -> SDK Setup -> Config). Keep your project in Test mode
         * while you try things out.
         */
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Put your config here (do NOT share publicly if you care about security). Example placeholder:
        const firebaseConfig = {
  apiKey: "AIzaSyCz0-ZM6qXh5E3NIPwJvf1RjwoyIuTmHQE",
  authDomain: "wiserobotics-exam.firebaseapp.com",
  projectId: "wiserobotics-exam",
  storageBucket: "wiserobotics-exam.firebasestorage.app",
  messagingSenderId: "438704959754",
  appId: "1:438704959754:web:1b3cc1eacd6a58c882caf3"
        };

        let db = null;
        let FIREBASE_ENABLED = false;

        try {
            // Only init if user pastes a real config
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== 'REPLACE_ME') {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                FIREBASE_ENABLED = true;
                console.log('Firebase initialized.');
            } else {
                console.warn('Firebase config not set — running in local practice mode.');
            }
        } catch (e) {
            console.error('Firebase init error:', e);
        }

        // ---------- App State ----------
        
        // --- Quiz Questions (30 Questions, 3 Options) ---
        const quizQuestions = [
            { question: "What does 'STEM' stand for?", options: ["Science, Technology, Engineering, and Mathematics", "Systematic Technical Equipment Management", "Standard Test for Educational Measures"], answer: "Science, Technology, Engineering, and Mathematics" },
            { question: "Which component acts as the 'brain' of a robot, executing instructions?", options: ["Actuator", "Microcontroller (or CPU)", "Power Supply"], answer: "Microcontroller (or CPU)" },
            { question: "In robotics, what is an 'actuator' primarily used for?", options: ["Detecting light", "Processing data", "Providing motion or control"], answer: "Providing motion or control" },
            { question: "What is the primary function of a 'sensor' in a robotic system?", options: ["To store energy", "To interact with the physical world and gather data", "To display output on a screen"], answer: "To interact with the physical world and gather data" },
            { question: "Which programming language is commonly used for educational robotics platforms like Arduino?", options: ["Python", "C/C++ (Arduino IDE)", "Java"], answer: "C/C++ (Arduino IDE)" },
            { question: "The process of a robot perceiving its environment and determining its location is called:", options: ["Pathfinding", "Localization", "Articulation"], answer: "Localization" },
            { question: "What is the study of motion without reference to the forces that cause it?", options: ["Dynamics", "Statics", "Kinematics"], answer: "Kinematics" },
            { question: "Which of the following is an example of an open-loop control system?", options: ["Thermostat", "Cruise control in a car", "A simple washing machine timer"], answer: "A simple washing machine timer" },
            { question: "What concept in engineering involves the calculation of how a robot's joints and links move to reach a desired endpoint?", options: ["Inverse Kinematics", "Forward Dynamics", "Sensing Feedback"], answer: "Inverse Kinematics" },
            { question: "Which field of science focuses on the properties and reactions of matter?", options: ["Physics", "Biology", "Chemistry"], answer: "Chemistry" },
            { question: "What does the 'A' in 'AI' (Artificial Intelligence) stand for?", options: ["Application", "Algorithm", "Artificial"], answer: "Artificial" },
            { question: "Which renewable energy source uses photovoltaic cells to convert sunlight directly into electricity?", options: ["Wind power", "Geothermal power", "Solar power"], answer: "Solar power" },
            { question: "In mathematics, what type of function creates a straight line when graphed?", options: ["Quadratic", "Exponential", "Linear"], answer: "Linear" },
            { question: "What is the smallest unit of digital information that a computer can process?", options: ["Byte", "Kilobyte", "Bit"], answer: "Bit" },
            { question: "Which metal is essential for making stainless steel and is often used in robotic structures for its strength?", options: ["Copper", "Aluminum", "Chromium"], answer: "Chromium" },
            { question: "What is the name for the collection of processes and data used to create a digital representation of a physical object?", options: ["3D Printing", "Scanning", "Modeling"], answer: "Modeling" },
            { question: "The principle that an object at rest stays at rest and an object in motion stays in motion unless acted upon by an external force is known as Newton's:", options: ["First Law", "Second Law", "Third Law"], answer: "First Law" },
            { question: "Which type of software is used to design and create technical drawings and models in engineering?", options: ["CAD (Computer-Aided Design)", "CAM (Computer-Aided Manufacturing)", "ERP (Enterprise Resource Planning)"], answer: "CAD (Computer-Aided Design)" },
            { question: "What is the phenomenon where a robot can sense its body position and movement?", options: ["Telepresence", "Proprioception", "Exteroception"], answer: "Proprioception" },
            { question: "What is the term for a machine that can perform complex series of actions automatically, especially one programmable by a computer?", options: ["Appliance", "Robot", "Calculator"], answer: "Robot" },
            { question: "What does CNC stand for in the context of manufacturing and machinery?", options: ["Central Network Control", "Computer Numerical Control", "Coded Navigation Command"], answer: "Computer Numerical Control" },
            { question: "If a robot runs out of power, which physical state variable is primarily being affected?", options: ["Velocity", "Kinetic Energy", "Potential Energy"], answer: "Kinetic Energy" },
            { question: "Which famous engineer is credited with designing the first working steam engine?", options: ["Nikola Tesla", "James Watt", "Thomas Edison"], answer: "James Watt" },
            { question: "What is the main function of an accelerometer sensor in a robot?", options: ["Measuring distance", "Measuring magnetic field", "Measuring linear acceleration (force)"], answer: "Measuring linear acceleration (force)" },
            { question: "What is the process of translating high-level programming code into machine-readable code?", options: ["Debugging", "Compilation", "Execution"], answer: "Compilation" },
            { question: "Which layer of the Earth's atmosphere contains the ozone layer?", options: ["Troposphere", "Mesosphere", "Stratosphere"], answer: "Stratosphere" },
            { question: "In Boolean algebra, what is the output of the expression 'A AND B' if A=True and B=False?", options: ["True", "False", "Undefined"], answer: "False" },
            { question: "What robotic joint typically allows rotation around a single axis, like a door hinge?", options: ["Prismatic joint", "Spherical joint", "Revolute joint"], answer: "Revolute joint" },
            { question: "What term describes the application of mathematical methods to biological problems?", options: ["Biophysics", "Bioengineering", "Biometrics"], answer: "Biometrics" },
            { question: "Which type of coding structure executes a block of code only if a specified condition is met?", options: ["Loop", "Function", "Conditional statement (if/else)"], answer: "Conditional statement (if/else)" }
        ];
        // For brevity while editing here, build the full list dynamically if not present
        if (quizQuestions.length < 30) {
            // copy the questions from your original file or regenerate until 30
            // This placeholder ensures the app still runs with at least 10 questions if not all copied
            while (quizQuestions.length < 30) {
                quizQuestions.push({ question: `Sample question ${quizQuestions.length+1}`, options: ["A","B","C"], answer: "A" });
            }
        }

        let state = {
            name: '', class: '', school: '', regNo: '', mode: 'practice',
            currentQuestion: 0, score: 0, chances: 5, submitted: false
        };

        // ---------- DOM ----------
        const welcomeArea = document.getElementById('welcomeArea');
        const quizArea = document.getElementById('quizArea');
        const resultArea = document.getElementById('resultArea');
        const inputName = document.getElementById('inputName');
        const inputClass = document.getElementById('inputClass');
        const inputSchool = document.getElementById('inputSchool');
        const inputRegNo = document.getElementById('inputRegNo');
        const startButton = document.getElementById('startButton');
        const welcomeFeedback = document.getElementById('welcomeFeedback');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const submitButton = document.getElementById('submitButton');
        const nextButton = document.getElementById('nextButton');
        const quitButton = document.getElementById('quitButton');
        const feedbackEl = document.getElementById('feedback');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const questionNumber = document.getElementById('questionNumber');
        const totalQuestions = document.getElementById('totalQuestions');
        const progressFill = document.getElementById('progressFill');
        const summaryName = document.getElementById('summaryName');
        const finalScoreText = document.getElementById('finalScoreText');
        const userDetailsSummary = document.getElementById('userDetailsSummary');
        const certificateArea = document.getElementById('certificateArea');
        const restartButton = document.getElementById('restartButton');
        const downloadCSV = document.getElementById('downloadCSV');
        const printCert = document.getElementById('printCert');

        totalQuestions.textContent = quizQuestions.length;

        // ---------- Helpers ----------
        function setProgress(qIndex) {
            const percent = Math.round((qIndex / quizQuestions.length) * 100);
            progressFill.style.width = `${percent}%`;
            questionNumber.textContent = qIndex + 1;
        }

        function shuffleOptions(options) {
            return options
                .map(value => ({ value, sort: Math.random() }))
                .sort((a, b) => a.sort - b.sort)
                .map(({ value }) => value);
        }

        // ---------- Render Question ----------
        let selectedOption = null;
        function renderQuestion() {
            const q = quizQuestions[state.currentQuestion];
            selectedOption = null;
            submitButton.disabled = true;
            nextButton.style.display = 'none';
            optionsContainer.innerHTML = '';
            questionText.textContent = q.question;

            const opts = shuffleOptions([...q.options]);
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-focus w-full text-left p-4 border rounded-xl bg-white btn';
                btn.textContent = opt;
                btn.onclick = () => {
                    // clear previous selects
                    optionsContainer.querySelectorAll('button').forEach(b => b.classList.remove('ring-2','ring-indigo-200','translate-y-[-2px]'));
                    btn.classList.add('ring-2','ring-indigo-200');
                    selectedOption = opt;
                    submitButton.disabled = false;
                };
                optionsContainer.appendChild(btn);
            });

            scoreDisplay.textContent = state.score;
            setProgress(state.currentQuestion);
        }

        // ---------- Submit Answer ----------
        function markAnswer(correct) {
            // simple animation
            feedbackEl.innerHTML = correct ? '<div class="p-3 rounded-lg bg-green-50 text-green-700">Correct ✅</div>' : '<div class="p-3 rounded-lg bg-red-50 text-red-700">Incorrect ❌</div>';
            scoreDisplay.textContent = state.score;
        }

        async function submitAnswer() {
            if (!selectedOption) return;

            const q = quizQuestions[state.currentQuestion];
            // disable choices
            optionsContainer.querySelectorAll('button').forEach(b => b.disabled = true);

            if (selectedOption === q.answer) {
                state.score++;
                markAnswer(true);
            } else {
                state.chances--;
                markAnswer(false);
                if (state.chances <= 0) {
                    // end quiz
                    setTimeout(() => endQuiz(false), 800);
                    return;
                }
            }

            // show next
            nextButton.style.display = 'inline-block';
            submitButton.style.display = 'none';
        }

        // ---------- Next / End ----------
        function nextQuestion() {
            state.currentQuestion++;
            submitButton.style.display = 'inline-block';
            if (state.currentQuestion >= quizQuestions.length) {
                endQuiz(true);
                return;
            }
            renderQuestion();
        }

        async function endQuiz(completed) {
            // completed: boolean, whether user finished or ran out of chances
            quizArea.style.display = 'none';
            resultArea.style.display = 'block';

            finalScoreText.textContent = `Final Score: ${state.score} / ${quizQuestions.length}`;
            userDetailsSummary.innerHTML = `<div><strong>Name:</strong> ${state.name}</div><div><strong>Class:</strong> ${state.class}</div><div><strong>School:</strong> ${state.school}</div><div><strong>Reg No:</strong> ${state.regNo || '-'} </div>`;

            // Certificate logic: >=70% passes
            const percent = Math.round((state.score / quizQuestions.length) * 100);
            if (percent >= 70) {
                certificateArea.innerHTML = generateCertificateHTML(state.name, state.school, state.class, state.score, quizQuestions.length, percent);
                printCert.style.display = 'inline-block';
            } else {
                certificateArea.innerHTML = `<div class="p-4 bg-orange-50 rounded-lg text-orange-800">Score ${percent}%. Minimum 70% required for certificate.</div>`;
            }

            // If mode=submit and firebase enabled, save
            if (state.mode === 'submit') {
                if (FIREBASE_ENABLED && db) {
                    try {
                        await addDoc(collection(db, 'exam_results'), {
                            name: state.name,
                            class: state.class,
                            school: state.school,
                            regNo: state.regNo || null,
                            score: state.score,
                            total: quizQuestions.length,
                            percent: percent,
                            timestamp: new Date().toISOString()
                        });
                        feedbackEl.innerHTML = '<div class="p-3 mt-3 rounded-lg bg-green-50 text-green-700">Result saved to cloud.</div>';
                    } catch (e) {
                        console.error(e);
                        feedbackEl.innerHTML = '<div class="p-3 mt-3 rounded-lg bg-red-50 text-red-700">Could not save to cloud. Check Firebase config and rules.</div>';
                    }
                } else {
                    feedbackEl.innerHTML = '<div class="p-3 mt-3 rounded-lg bg-yellow-50 text-yellow-700">Save requested but Firebase not configured. Results not saved.</div>';
                }
            }

            // show download CSV only for admin (we'll toggle visibility when admin unlocks)
            downloadCSV.style.display = 'none';
        }

        // ---------- Certificate HTML ----------
        function generateCertificateHTML(name, school, className, score, total, percent) {
            return `
                <div id="certificate" class="p-6 bg-white rounded-xl border-t-8 border-indigo-600 shadow-lg inline-block text-left max-w-2xl">
                    <h3 class="text-3xl font-extrabold text-indigo-700">CERTIFICATE OF EXCELLENCE</h3>
                    <p class="mt-2 text-gray-700">This certifies that</p>
                    <div class="mt-4 text-3xl font-black text-teal-600">${(name||'---').toUpperCase()}</div>
                    <div class="mt-2 text-sm text-gray-700">of <strong>${school || '---'}</strong> (${className || '---'})</div>
                    <div class="mt-4 text-lg">has successfully completed the <strong>WISEROBOTICS & STEM CHALLENGE</strong></div>
                    <div class="mt-4 text-2xl font-extrabold text-gray-800">Score: ${score}/${total} (${percent}%)</div>
                    <div class="mt-6 text-sm text-gray-500">Date: ${new Date().toLocaleDateString()}</div>
                </div>
            `;
        }

        // ---------- Admin: download all results as CSV (requires Firebase) ----------
        async function adminDownloadCSV() {
            if (!FIREBASE_ENABLED || !db) return alert('Firebase not configured.');
            try {
                const q = await getDocs(collection(db, 'exam_results'));
                const rows = [];
                q.forEach(doc => rows.push(doc.data()));
                if (!rows.length) return alert('No results available.');

                // build CSV
                const headers = ['name','class','school','regNo','score','total','percent','timestamp'];
                const csv = [headers.join(',')];
                rows.forEach(r => {
                    const line = headers.map(h => `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(',');
                    csv.push(line);
                });
                const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `exam_results_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error(e);
                alert('Error retrieving results. Check console.');
            }
        }

        // ---------- Events ----------
        startButton.addEventListener('click', () => {
            const name = inputName.value.trim();
            const classVal = inputClass.value.trim();
            const school = inputSchool.value.trim();
            const regNo = inputRegNo.value.trim();
            const mode = document.getElementById('modeSelect').value;

            if (!name || !classVal || !school) {
                welcomeFeedback.textContent = 'Please fill in Name, Class, and School to continue.';
                return;
            }

            state.name = name; state.class = classVal; state.school = school; state.regNo = regNo; state.mode = mode;
            summaryName.textContent = state.name;
            welcomeArea.style.display = 'none';
            quizArea.style.display = 'block';
            renderQuestion();
        });

        submitButton.addEventListener('click', submitAnswer);
        nextButton.addEventListener('click', () => {
            // restore submit button visibility
            submitButton.style.display = 'inline-block';
            nextQuestion();
        });
        quitButton.addEventListener('click', () => {
            if (confirm('Quit the challenge? Progress will be lost.')) location.reload();
        });
        restartButton.addEventListener('click', () => location.reload());
        downloadCSV.addEventListener('click', adminDownloadCSV);
        printCert.addEventListener('click', () => window.print());

        // Admin unlock to show download button
        document.getElementById('adminLogin').addEventListener('click', () => {
            const key = document.getElementById('adminKey').value;
            // NOTE: This is a simple client-side toggle. For production, build a real admin auth.
            if (key === 'wiserdash') {
                alert('Admin unlocked. You can download results.');
                downloadCSV.style.display = 'inline-block';
            } else {
                alert('Wrong admin pass. (default: wiserdash)');
            }
        });

        // allow keyboard submit (Enter)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && quizArea.style.display === 'block' && !submitButton.disabled && submitButton.style.display !== 'none') {
                submitAnswer();
            }
        });

        // Accessibility: focus first input
        inputName.focus();

    </script>

</body>
</html>

